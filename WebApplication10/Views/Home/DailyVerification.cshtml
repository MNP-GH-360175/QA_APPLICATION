@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">
            <i class="fas fa-check-circle me-2"></i>Daily Release Verification
        </h3>
        <span class="text-muted small">Verify released CRFs daily</span>
    </div>

    <!-- Filters Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional & Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Please select release type</div>
                    </div>

                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>

                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>

                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">Tester TL</label>
                        <select class="form-select form-select-lg" id="testerTL">
                            <option value="">All TLs</option>
                        </select>
                    </div>

                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">Tester Name</label>
                        <select class="form-select form-select-lg" id="testerName">
                            <option value="">All Testers</option>
                        </select>
                    </div>

                    <div class="col-lg-1 col-md-12 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg h-100">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table Card -->
    <div class="card shadow border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Verification List</h5>
            <small class="text-light opacity-90">
                <i class="fas fa-info-circle me-1"></i>
                Select Status + Add Remarks → Click <strong>Confirm</strong>
            </small>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle text-nowrap" id="verificationTable">
                    <thead class="table-primary sticky-top shadow-sm" style="z-index: 10;">
                        <tr>
                            <th class="ps-4">CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th class="text-center">Status *</th>
                            <th>Remarks *</th>
                            <th>Attachment</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody" class="bg-white"></tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="text-center py-5 text-muted" id="emptyState" style="display:none;">
                <i class="fas fa-inbox fa-4x mb-3 opacity-25"></i>
                <h5>No records found</h5>
                <p>Try adjusting your filters</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const STATUS_OPTIONS = ["Working", "Not Working", "In Progress", "Data need to capture", "User feedback pending"];
    const STATUS_MAP = { 1: "Working", 2: "Not Working", 3: "In Progress", 4: "Data need to capture", 5: "User feedback pending" };

    let verificationData = [];

    const normalizeKeys = obj => new Proxy(obj, {
        get(target, prop) {
            if (prop in target) return target[prop];
            const upper = prop.toUpperCase();
            const found = Object.keys(target).find(k => k.toUpperCase() === upper);
            return found ? target[found] : undefined;
        }
    });

    async function loadFilterDropdowns() {
        try {
            const token = localStorage.getItem('jwtToken');
            const res = await fetch('/api/DailyVerification/filters', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error("Failed");
            const data = await res.json();

            const tlSelect = document.getElementById("testerTL");
            tlSelect.innerHTML = '<option value="">All TLs</option>';
            data.testerTLs?.forEach(x => tlSelect.add(new Option(x.text, x.value)));

            const testerSelect = document.getElementById("testerName");
            testerSelect.innerHTML = '<option value="">All Testers</option>';
            data.testerNames?.forEach(x => testerSelect.add(new Option(x.text, x.value)));
        } catch (err) {
            console.error(err);
        }
    }

    function formatDateForOracle(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
    }

    document.getElementById("filterForm").addEventListener("submit", async e => {
        e.preventDefault();

        let valid = true;
        document.querySelectorAll("#filterForm [required]").forEach(el => {
            if (!el.value.trim()) {
                el.classList.add("is-invalid");
                valid = false;
            } else {
                el.classList.remove("is-invalid");
            }
        });
        if (!valid) return;

        const payload = {
            fromDate: formatDateForOracle(document.getElementById("fromDate").value),
            toDate: formatDateForOracle(document.getElementById("toDate").value),
            releaseType: document.getElementById("releaseType").value || null,
            testerTL: document.getElementById("testerTL").value || null,
            testerName: document.getElementById("testerName").value || null
        };

        const token = localStorage.getItem('jwtToken');
        try {
            const res = await fetch('/api/DailyVerification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());

            const rawData = await res.json();
            verificationData = rawData.map(item => normalizeKeys(item));

            verificationData.forEach(item => {
                item.crfId = item.CRF_ID || "N/A";
                item.requestId = item.REQUEST_ID || "";
                item.subject = item.CRF_NAME || "Unknown CRF";
                item.releaseDate = item.RELEASE_DATE || "";
                item.techlead = item.TECHLEAD_NAME || "Not Assigned";
                item.developer = item.DEVELOPER_NAME || "Not Assigned";
                item.tester = item.TESTER_NAME || "Not Assigned";
                item.releaseTypeText = item.RELEASE_TYPE || "";

                const statusCode = item.WORKING_STATUS ? Number(item.WORKING_STATUS) : null;
                const verifiedToday = item.VERIFIED_ON && new Date().toDateString() === new Date(item.VERIFIED_ON).toDateString();

                if (verifiedToday && statusCode) {
                    item.workingStatus = STATUS_MAP[statusCode] || "";
                    item.remarks = item.REMARKS || "";
                    item.attachmentName = item.ATTACHMENT_NAME || "";
                    item.isConfirmed = true;
                } else {
                    item.workingStatus = "";
                    item.remarks = "";
                    item.attachmentName = "";
                    item.isConfirmed = false;
                }

                try {
                    item.History = JSON.parse(item.HISTORY_JSON || "[]");
                } catch {
                    item.History = [];
                }
            });

            const hasData = verificationData.length > 0;
            document.getElementById("resultCard").style.display = hasData ? "block" : "none";
            document.getElementById("emptyState").style.display = hasData ? "none" : "block";
            renderTable();
        } catch (err) {
            alert("Error: " + err.message);
        }
    });

    function renderTable() {
        const tbody = document.getElementById("verificationBody");
        tbody.innerHTML = "";

        if (verificationData.length === 0) {
            document.getElementById("emptyState").style.display = "block";
            return;
        }

        verificationData.forEach((item, idx) => {
            const isDaily = item.releaseTypeText.includes("Daily");
            const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
            const badgeText = isDaily ? "Daily" : "Exp.";

            const canConfirm = item.workingStatus && (item.remarks || "").trim().length > 0;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="ps-4"><a href="#" class="text-decoration-none fw-bold text-primary crf-link" data-idx="${idx}">${item.crfId}</a></td>
                <td><span class="badge bg-secondary fs-7">${item.requestId || 'N/A'}</span></td>
                <td><span class="badge ${badgeCls} fs-7">${badgeText}</span></td>
                <td class="text-wrap" title="${item.subject}">${item.subject.length > 50 ? item.subject.substring(0,47)+'...' : item.subject}</td>
                <td>${item.releaseDate}</td>
                <td><strong>${item.techlead}</strong></td>
                <td>${item.developer}</td>
                <td>${item.tester}</td>
                <td class="text-center">
                    ${item.isConfirmed
                        ? `<span class="badge bg-success px-3 py-2 fs-7">${item.workingStatus}</span>
                           <button class="btn btn-sm btn-outline-warning ms-2 edit-btn" data-idx="${idx}">Edit</button>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${idx}">
                              <option value="">-- Select --</option>
                              ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${item.workingStatus === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                           </select>`
                    }
                </td>
                <td>
                    <textarea class="form-control form-control-sm remarks-text w-100" rows="2" data-idx="${idx}" ${item.isConfirmed ? 'readonly' : ''}>${item.remarks || ''}</textarea>
                    <small class="text-muted word-count">${(item.remarks || '').trim().split(/\s+/).filter(Boolean).length} words</small>
                </td>
                <td>
                    ${!item.isConfirmed
                        ? `<input type="file" class="form-control form-control-sm file-input" data-idx="${idx}" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">`
                        : (item.attachmentName ? `<a href="#" class="text-primary download-link" data-idx="${idx}"><i class="fas fa-paperclip me-1"></i>${item.attachmentName}</a>` : '-')
                    }
                </td>
                <td class="text-center">
                    <button class="btn ${item.isConfirmed ? 'btn-success' : (canConfirm ? 'btn-primary' : 'btn-secondary')} btn-sm px-4 confirm-btn"
                            data-idx="${idx}" ${item.isConfirmed || !canConfirm ? 'disabled' : ''}>
                        ${item.isConfirmed ? '<i class="fas fa-check"></i> Confirmed' : 'Confirm'}
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        attachEvents();
    }

    function attachEvents() {
        document.querySelectorAll(".status-select").forEach(sel => {
            sel.addEventListener("change", e => {
                const idx = e.target.dataset.idx;
                verificationData[idx].workingStatus = e.target.value;
                updateConfirmButton(idx);
            });
        });

        document.querySelectorAll(".remarks-text").forEach(ta => {
            ta.addEventListener("input", e => {
                const idx = e.target.dataset.idx;
                verificationData[idx].remarks = e.target.value;
                const words = e.target.value.trim().split(/\s+/).filter(w => w).length;
                e.target.nextElementSibling.textContent = words + " words";
                updateConfirmButton(idx);
            });
        });

        document.querySelectorAll(".confirm-btn").forEach(btn => {
            btn.addEventListener("click", e => {
                const idx = e.target.closest("button").dataset.idx;
                saveItem(verificationData[idx]);
            });
        });

        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.addEventListener("click", e => {
                const idx = e.target.dataset.idx;
                verificationData[idx].isConfirmed = false;
                renderTable();
            });
        });

        document.querySelectorAll(".crf-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                const idx = e.target.dataset.idx;
                showHistoryModal(verificationData[idx].History, verificationData[idx].crfId, verificationData[idx].releaseTypeText);
            });
        });
    }

    function updateConfirmButton(idx) {
        const item = verificationData[idx];
        const can = item.workingStatus && (item.remarks || "").trim();
        const btn = document.querySelector(`.confirm-btn[data-idx="${idx}"]`);
        if (btn) {
            btn.disabled = item.isConfirmed || !can;
            btn.className = `btn btn-sm px-4 ${item.isConfirmed ? 'btn-success' : (can ? 'btn-primary' : 'btn-secondary')} confirm-btn`;
            btn.innerHTML = item.isConfirmed ? '<i class="fas fa-check"></i> Confirmed' : 'Confirm';
        }
    }

    async function saveItem(item) {
        const file = document.querySelector(`.file-input[data-idx]`)?.files[0];
        let attachmentBase64 = null, attachmentName = null, attachmentMime = null;

        if (file) {
            attachmentBase64 = await fileToBase64(file);
            attachmentName = file.name;
            attachmentMime = file.type;
        }

        const payload = [{
            crfId: item.crfId,
            requestId: item.requestId,
            workingStatus: item.workingStatus,
            remarks: item.remarks?.trim(),
            attachmentName: attachmentName || item.attachmentName,
            attachmentBase64: attachmentBase64,
            attachmentMime: attachmentMime
        }];

        const token = localStorage.getItem('jwtToken');
        try {
            const res = await fetch('/api/DailyVerification/Save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("Saved successfully!");
                document.getElementById("filterForm").dispatchEvent(new Event("submit"));
            } else {
                alert("Failed: " + await res.text());
            }
        } catch (err) {
            alert("Error: " + err);
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function showHistoryModal(history, crfId, type) {
        const isDaily = type?.includes("Daily");
        const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
        const badgeText = isDaily ? "Daily" : "Exp.";

        const rows = history.length === 0
            ? `<p class="text-center text-muted py-5">No history available</p>`
            : history.map(h => `
                <div class="d-flex gap-3 py-3 border-bottom">
                    <div class="flex-shrink-0">
                        <div class="bg-${h.text === 'Working' ? 'success' : 'danger'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width:46px;height:46px;">
                            ${h.text[0]}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold text-${h.text === 'Working' ? 'success' : 'danger'}">${h.text}</div>
                        <small class="text-muted">by <strong>${h.by}</strong> on ${h.at}</small>
                        ${h.note ? `<div class="mt-2 p-3 bg-light rounded small">${h.note.replace(/\n/g, '<br>')}</div>` : '<em class="text-muted small">No remarks</em>'}
                        ${h.file ? `<div class="mt-2"><span class="badge bg-info text-dark">${h.file}</span></div>` : ''}
                    </div>
                </div>
            `).join('');

        const modalHtml = `
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Verification History: <strong>${crfId}</strong> <span class="badge ${badgeCls} ms-2">${badgeText}</span></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                        ${rows}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>`;

        const div = document.createElement('div');
        div.innerHTML = modalHtml;
        document.body.appendChild(div.firstChild);
        new bootstrap.Modal('#historyModal').show();
        document.getElementById('historyModal').addEventListener('hidden.bs.modal', () => div.remove());
    }

    document.addEventListener("DOMContentLoaded", loadFilterDropdowns);
</script>

<style>
    :root {
        --bs-border-radius: .5rem;
        --bs-border-radius-lg: .8rem;
    }

    .card {
        border-radius: var(--bs-border-radius-lg);
        overflow: hidden;
    }

    .form-select-lg, .form-control-lg {
        font-size: 1rem;
        padding: .6rem 1rem;
    }

    .table th {
        font-weight: 600;
        font-size: .95rem;
        background: #f8f9fa;
    }

    .sticky-top {
        top: 0;
        background: white !important;
    }

    }

    .badge {
        font-size: 0.8rem;
    }

    .confirm-btn {
        min-width: 100px;
        transition: all 0.2s;
    }

    .word-count {
        font-size: 0.75rem;
        margin-top: 4px;
    }

    textarea[readonly] {
        background-color: #f8f9fa !important;
        opacity: 0.8;
    }

    @@media (max-width: 768px) {
        .table {
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: .75rem !important;
        }

        .confirm-btn {
            min-width: 90px;
            font-size: 0.85rem;
        }
    }

    @@media (max-width: 576px) {
        .col-lg-3, .col-lg-2, .col-lg-1 {
            width: 100%;
        }

        h3 {
            font-size: 1.35rem;
        }

        .card-header h6 {
            font-size: 1rem;
        }
    
    }
</style>
}