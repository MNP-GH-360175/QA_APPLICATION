@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4">
    <h3 class="mb-4 text-primary">Daily Release Verification</h3>

    <!-- Filters -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional & Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester TL</label>
                        <select class="form-select" id="testerTL">
                            <option value="">All TLs</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester Name</label>
                        <select class="form-select" id="testerName">
                            <option value="">All Testers</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card shadow-sm border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Verification List</h5>
            <small class="text-light">Select Status + Add Remarks → Click Confirm</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th width="180">Working Status *</th>
                            <th width="300">Remarks *</th>
                            <th width="180">Attachment</th>
                            <th width="130">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const STATUS_OPTIONS = [
            "Working",
            "Not Working",
            "In Progress",
            "Data need to capture",
            "User feedback pending"
        ];

        const STATUS_MAP = {
            1: "Working",
            2: "Not Working",
            3: "In Progress",
            4: "Data need to capture",
            5: "User feedback pending"
        };

        function getStatusText(code) {
            return STATUS_MAP[code] || "Unknown";
        }
        let verificationData = [];

        // Case-insensitive proxy to handle Oracle's random column casing
        const normalizeKeys = obj => new Proxy(obj, {
            get(target, prop) {
                if (prop in target) return target[prop];
                const upper = prop.toUpperCase();
                const found = Object.keys(target).find(k => k.toUpperCase() === upper);
                return found ? target[found] : undefined;
            }
        });

        async function loadFilterDropdowns() {
            try {
                const token = localStorage.getItem('jwtToken');
                const res = await fetch('/api/DailyVerification/filters', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error("Failed to load filters");
                const data = await res.json();

                const tlSelect = document.getElementById("testerTL");
                tlSelect.innerHTML = '<option value="">All TLs</option>';
                data.testerTLs?.forEach(x => tlSelect.add(new Option(x.text, x.value)));

                const testerSelect = document.getElementById("testerName");
                testerSelect.innerHTML = '<option value="">All Testers</option>';
                data.testerNames?.forEach(x => testerSelect.add(new Option(x.text, x.value)));
            } catch (err) {
                console.error("Failed to load dropdowns:", err);
            }
        }

        function formatDateForOracle(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        function getStatusText(code) {
            return STATUS_MAP[code] || "";
        }

        // Main Search
        document.getElementById("filterForm").addEventListener("submit", async e => {
            e.preventDefault();

            let valid = true;
            document.querySelectorAll("#filterForm [required]").forEach(el => {
                if (!el.value) {
                    el.classList.add("is-invalid");
                    valid = false;
                } else {
                    el.classList.remove("is-invalid");
                }
            });
            if (!valid) return;

            const payload = {
                fromDate: formatDateForOracle(document.getElementById("fromDate").value),
                toDate: formatDateForOracle(document.getElementById("toDate").value),
                releaseType: document.getElementById("releaseType").value || null,
                testerTL: document.getElementById("testerTL").value || null,
                testerName: document.getElementById("testerName").value || null
            };

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                verificationData = (await res.json()).map(item => normalizeKeys(item));

                // Map data to clean properties
                verificationData.forEach(item => {
                    item.crfId = item.CRF_ID || "N/A";
                    item.requestId = item.REQUEST_ID || "";
                    item.subject = item.CRF_NAME || "Unknown CRF";
                    item.releaseDate = item.RELEASE_DATE || "";
                    item.techlead = item.TECHLEAD_NAME || "Not Assigned";
                    item.developer = item.DEVELOPER_NAME || "Not Assigned";
                    item.tester = item.TESTER_NAME || "Not Assigned";
                    item.testerTL = item.TESTER_TL_NAME || "Not Assigned";
                    item.releaseTypeText = item.RELEASE_TYPE || "";

                    const statusCode = item.WORKING_STATUS ? Number(item.WORKING_STATUS) : null;
                    const verifiedToday = item.VERIFIED_ON &&
                        new Date().toDateString() === new Date(item.VERIFIED_ON).toDateString();

                    if (verifiedToday && statusCode) {
                        item.workingStatus = getStatusText(statusCode);
                        item.remarks = item.REMARKS || "";
                        item.attachmentName = item.ATTACHMENT_NAME || "";
                        item.verifiedBy = item.VERIFIED_BY || "";
                        item.verifiedOn = item.VERIFIED_ON || "";
                        item.isConfirmed = true;
                    } else {
                        item.workingStatus = "";
                        item.remarks = "";
                        item.attachmentName = "";
                        item.verifiedBy = "";
                        item.verifiedOn = "";
                        item.isConfirmed = false;
                    }

                    try {
                        item.History = JSON.parse(item.HISTORY_JSON || "[]");
                    } catch {
                        item.History = [];
                    }
                });

                document.getElementById("resultCard").style.display = verificationData.length ? "block" : "none";
                renderTable();

            } catch (err) {
                alert("Error: " + err.message);
                console.error(err);
            }
        });

        function renderTable() {
            const tbody = document.getElementById("verificationBody");
            tbody.innerHTML = "";

            verificationData.forEach((item, idx) => {
                const isDaily = item.releaseTypeText.includes("Daily");
                const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
                const badgeText = isDaily ? "Daily" : "Exp.";
                const canConfirm = !!item.workingStatus && !!(item.remarks || "").trim();

                const tr = document.createElement("tr");
                tr.innerHTML = `
                        <td><a href="#" class="text-primary fw-bold crf-link" data-idx="${idx}">${item.crfId}</a></td>
                        <td><span class="badge bg-secondary">${item.requestId || 'N/A'}</span></td>
                        <td><span class="badge ${badgeCls}">${badgeText}</span></td>
                        <td title="${item.subject}">${item.subject.length > 60 ? item.subject.substring(0, 57) + '...' : item.subject}</td>
                        <td>${item.releaseDate}</td>
                        <td><strong>${item.techlead}</strong></td>
                        <td>${item.developer}</td>
                        <td>${item.tester}</td>
                        <td>
                            ${item.isConfirmed
                        ? `<span class="badge bg-success px-3 py-2">${item.workingStatus}</span>
                                   <button class="btn btn-sm btn-outline-warning ms-2 edit-btn" data-idx="${idx}">Edit</button>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${idx}">
                                       <option value="">-- Select --</option>
                                       ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${item.workingStatus === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                   </select>`
                    }
                        </td>
                        <td>
                            <textarea class="form-control form-control-sm remarks-text" rows="2" data-idx="${idx}" ${item.isConfirmed ? 'readonly' : ''}>${item.remarks || ''}</textarea>
                            <small class="text-muted d-block word-count">${(item.remarks || '').trim().split(/\s+/).filter(w => w).length} words</small>
                        </td>
                        <td>
                            ${!item.isConfirmed ? `<input type="file" class="form-control form-control-sm file-input" data-idx="${idx}">` : ''}
                            ${item.attachmentName ? `<a href="#" class="text-primary download-link" data-idx="${idx}">${item.attachmentName}</a>` : ''}
                        </td>
                        <td>
                            <button class="btn btn-sm ${item.isConfirmed ? 'btn-success' : (canConfirm ? 'btn-primary' : 'btn-secondary')} confirm-btn"
                                    data-idx="${idx}" ${item.isConfirmed || !canConfirm ? 'disabled' : ''}>
                                ${item.isConfirmed ? 'Confirmed' : 'Confirm'}
                            </button>
                        </td>
                    `;
                tbody.appendChild(tr);
            });

            attachEvents();
        }

        function attachEvents() {
            const tbody = document.getElementById("verificationBody");

            tbody.addEventListener("change", e => {
                if (e.target.classList.contains("status-select")) {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].workingStatus = e.target.value;
                    updateConfirmButton(idx);
                }
            });

            tbody.addEventListener("input", e => {
                if (e.target.classList.contains("remarks-text")) {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].remarks = e.target.value;
                    const words = (e.target.value || "").trim().split(/\s+/).filter(w => w).length;
                    e.target.nextElementSibling.textContent = words + " words";
                    updateConfirmButton(idx);
                }
            });

            tbody.onclick = e => {
                const idx = e.target.dataset.idx;
                if (idx === undefined) return;
                const item = verificationData[idx];

                if (e.target.classList.contains("confirm-btn") && !e.target.disabled) {
                    saveItem(item);
                }
                if (e.target.classList.contains("edit-btn")) {
                    item.isConfirmed = false;
                    renderTable();
                }
                if (e.target.classList.contains("crf-link")) {
                    e.preventDefault();
                    showHistoryModal(item.History, item.crfId, item.releaseTypeText);
                }
            };
        }

        function updateConfirmButton(idx) {
            const item = verificationData[idx];
            const row = document.querySelector(`[data-idx="${idx}"]`).closest("tr");
            const btn = row.querySelector(".confirm-btn");
            const can = !!item.workingStatus && !!(item.remarks || "").trim();
            btn.disabled = !can;
            btn.className = `btn btn-sm ${can ? 'btn-primary' : 'btn-secondary'} confirm-btn`;
            btn.textContent = item.isConfirmed ? 'Confirmed' : 'Confirm';
        }

        async function saveItem(item) {
            const payload = [{
                crfId: item.crfId,
                requestId: item.requestId,
                workingStatus: item.workingStatus,
                remarks: item.remarks?.trim() || "",
                attachmentName: item.attachmentName || null,
                attachmentBase64: item.attachmentBase64 || null,
                attachmentMime: item.attachmentMime || null
            }];

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification/Save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Saved successfully!");
                    document.getElementById("filterForm").dispatchEvent(new Event("submit"));
                } else {
                    alert("Save failed: " + await res.text());
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        function showHistoryModal(history, crfId, type) {
            const isDaily = type?.includes("Daily");
            const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
            const badgeText = isDaily ? "Daily" : "Exp.";

            const rows = history.length === 0
                ? `<p class="text-center text-muted my-4">No history</p>`
                : history.map(h => `
                        <div class="d-flex gap-3 mb-3 pb-3 border-bottom">
                            <div class="flex-shrink-0">
                                <div class="bg-${h.text === 'Working' ? 'success' : 'danger'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px;height:40px;font-size:18px;">
                                    ${h.text?.[0] || '?'}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold text-${h.text === 'Working' ? 'success' : 'danger'}">${h.text || 'Unknown'}</div>
                                <div class="small text-muted">by <strong>${h.by || 'Unknown'}</strong> • ${h.at || ''}</div>
                                ${h.note ? `<div class="mt-2 p-3 bg-light rounded">${h.note.replace(/\n/g, '<br>')}</div>` : '<em class="text-muted">No remarks</em>'}
                                ${h.file ? `<div class="mt-2"><span class="badge bg-info">${h.file}</span></div>` : ''}
                            </div>
                        </div>
                    `).join('');

            const modal = document.createElement('div');
            modal.innerHTML = `
                    <div class="modal fade" id="histModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">History: <strong>${crfId}</strong> <span class="badge ${badgeCls} ms-2">${badgeText}</span></h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body pt-4">${rows}</div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            document.body.appendChild(modal.firstElementChild);
            new bootstrap.Modal('#histModal').show();
        }

        document.addEventListener("DOMContentLoaded", loadFilterDropdowns);
    </script>

    <style>
        .is-invalid {
            border-color: #dc3545 !important;
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .crf-link:hover {
            text-decoration: underline;
        }

        textarea[readonly] {
            background-color: #f8f9fa;
        }
    </style>
}