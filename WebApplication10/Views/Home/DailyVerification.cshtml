@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4">
    <h3 class="mb-4 text-primary">
        <i class="fas fa-check-circle me-2"></i>Daily Release Verification
    </h3>

    <!-- Filters -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional and Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester TL</label>
                        <select class="form-select" id="testerTL">
                            <option value="">All TLs</option>
                            @foreach (var item in ViewBag.TesterTLs as List<SelectListItem>)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester Name</label>
                        <select class="form-select" id="testerName">
                            <option value="">All Testers</option>
                            @foreach (var item in ViewBag.TesterNames as List<SelectListItem>)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card shadow-sm border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <h5 class="mb-0"><i class="fas fa-list-ul me-2"></i>Verification List</h5>
            <small class="text-light">Fill Status + Remarks → Click Confirm</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>CRF ID</th>
                            <th width="110">Type</th>
                            <th>CRF Name</th>
                            <th width="140">Release Date</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th width="180">Working Status *</th>
                            <th width="300">Remarks *</th>
                            <th width="180">Attachment</th>
                            <th width="130">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let verificationData = [];
        let selectedReleaseType = "";

        function formatDateForOracle(dateStr) {
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        function getStatusBadge(status) {
            const map = {
                "Working": "bg-success text-white",
                "Not Working": "bg-danger text-white",
                "Partially Working": "bg-info text-white",
                "In Progress": "bg-warning text-dark",
                "On Hold": "bg-secondary text-white"
            };
            return map[status] || "bg-secondary text-white";
        }

        // Search
        document.getElementById("filterForm").addEventListener("submit", async e => {
            e.preventDefault();
            let valid = true;
            document.querySelectorAll("#filterForm [required]").forEach(el => {
                if (!el.value.trim()) { el.classList.add("is-invalid"); valid = false; }
                else el.classList.remove("is-invalid");
            });
            if (!valid) return;

            selectedReleaseType = document.getElementById("releaseType").value;

            const payload = {
                fromDate: formatDateForOracle(document.getElementById("fromDate").value),
                toDate: formatDateForOracle(document.getElementById("toDate").value),
                releaseType: selectedReleaseType || null,
                testerTL: document.getElementById("testerTL").value || null,
                testerName: document.getElementById("testerName").value || null
            };

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) { alert("Search failed: " + await res.text()); return; }

                verificationData = await res.json();

                verificationData.forEach(item => {
                    item.crfId = item.CRF_ID?.trim() || "N/A";
                    item.subject = item.CRF_NAME || "Not Available";
                    item.releaseDate = item.RELEASE_DATE || "";
                    item.developer = item.DEVELOPER_NAME || "Not Assigned";
                    item.tester = item.TESTER_NAME || "Not Assigned";

                    // Parse history
                    try {
                        item.History = typeof item.HISTORY_JSON === "string" ? JSON.parse(item.HISTORY_JSON || "[]") : (item.HISTORY_JSON || []);
                    } catch { item.History = []; }

                    // Check if already verified today
                    const today = new Date().toDateString();
                    const verifiedToday = item.CURRENT_VERIFIED_ON && new Date(item.CURRENT_VERIFIED_ON).toDateString() === today;

                    if (verifiedToday && item.CURRENT_STATUS) {
                        item.workingStatus = item.CURRENT_STATUS;
                        item.remarks = item.CURRENT_REMARKS || "";
                        item.attachmentName = item.CURRENT_ATTACHMENT_NAME || "";
                        item.isConfirmed = true;
                    } else {
                        item.workingStatus = "";
                        item.remarks = "";
                        item.attachmentName = "";
                        item.attachmentBase64 = null;
                        item.isConfirmed = false;
                    }
                });

                document.getElementById("resultCard").style.display = verificationData.length ? "block" : "none";
                if (verificationData.length === 0) {
                    alert("No records found.");
                } else {
                    renderTable();
                }
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        });

        function renderTable() {
            const tbody = document.getElementById("verificationBody");
            tbody.innerHTML = "";

            verificationData.forEach((item, idx) => {
                const isDaily = selectedReleaseType === "Daily Release Report";
                const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
                const badgeText = isDaily ? "Daily" : "Exp.";

                const canConfirm = item.workingStatus && item.remarks?.trim();

                const row = document.createElement("tr");
                row.innerHTML = `
                            <td>
                                <a href="#" class="text-primary fw-bold crf-link" data-idx="${idx}">${item.crfId}</a>
                            </td>
                            <td><span class="badge ${badgeCls} px-3 py-2">${badgeText}</span></td>
                            <td>${item.subject}</td>
                            <td>${item.releaseDate}</td>
                            <td>${item.developer}</td>
                            <td><span class="badge bg-info text-white">${item.tester}</span></td>
                            <td>
                                ${item.isConfirmed
                        ? `<span class="badge ${getStatusBadge(item.workingStatus)} px-3 py-2">${item.workingStatus}</span>
                                       <button class="btn btn-sm btn-warning ms-2 edit-btn" data-idx="${idx}">Edit</button>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${idx}">
                                        <option value="">-- Select Status --</option>
                                        <option value="Working" ${item.workingStatus === 'Working' ? 'selected' : ''}>Working</option>
                                        <option value="Not Working" ${item.workingStatus === 'Not Working' ? 'selected' : ''}>Not Working</option>
                                        <option value="Partially Working" ${item.workingStatus === 'Partially Working' ? 'selected' : ''}>Partially Working</option>
                                        <option value="In Progress" ${item.workingStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="On Hold" ${item.workingStatus === 'On Hold' ? 'selected' : ''}>On Hold</option>
                                       </select>`
                    }
                            </td>
                            <td>
                                <textarea class="form-control form-control-sm remarks-text" rows="2" data-idx="${idx}" ${item.isConfirmed ? 'readonly' : ''}>${item.remarks || ''}</textarea>
                                <small class="text-muted d-block">${(item.remarks || '').trim().split(/\s+/).filter(w => w).length} words</small>
                            </td>
                            <td>
                                ${!item.isConfirmed ? `<input type="file" class="form-control form-control-sm" data-idx="${idx}">` : ''}
                                ${item.attachmentName ? `<a href="#" class="btn btn-sm btn-outline-primary download-btn" data-idx="${idx}"><i class="fas fa-paperclip"></i> ${item.attachmentName}</a>` : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm ${item.isConfirmed ? 'btn-success' : 'btn-primary'} confirm-btn"
                                        data-idx="${idx}" ${item.isConfirmed || !canConfirm ? 'disabled' : ''}>
                                    ${item.isConfirmed ? '<i class="fas fa-check"></i> Confirmed' : '<i class="fas fa-save"></i> Confirm'}
                                </button>
                            </td>
                        `;
                tbody.appendChild(row);
            });

            attachEvents();
        }

        function attachEvents() {
            document.getElementById("verificationBody").addEventListener("click", e => {
                const idx = e.target.dataset.idx;
                if (idx === undefined) return;
                const item = verificationData[idx];

                // Update status
                if (e.target.classList.contains("status-select")) {
                    item.workingStatus = e.target.value;
                    renderTable(); // Re-render to update Confirm button
                }

                // Update remarks
                if (e.target.classList.contains("remarks-text")) {
                    setTimeout(() => {
                        item.remarks = e.target.value;
                        e.target.nextElementSibling.textContent = (item.remarks || '').trim().split(/\s+/).filter(w => w).length + " words";
                        renderTable(); // Update Confirm button
                    }, 100);
                }

                // File upload
                if (e.target.type === "file" && e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.size > 10 * 1024 * 1024) { alert("Max 10MB"); e.target.value = ""; return; }
                    const reader = new FileReader();
                    reader.onload = () => {
                        item.attachmentBase64 = reader.result;
                        item.attachmentName = file.name;
                        item.attachmentMime = file.type;
                    };
                    reader.readAsDataURL(file);
                }

                // Confirm
                if (e.target.classList.contains("confirm-btn") && !e.target.disabled) {
                    saveItem(item);
                }

                // Edit
                if (e.target.classList.contains("edit-btn")) {
                    item.isConfirmed = false;
                    renderTable();
                }

                // Download
                if (e.target.classList.contains("download-btn")) {
                    e.preventDefault();
                    if (item.attachmentBase64) {
                        const a = document.createElement("a");
                        a.href = item.attachmentBase64;
                        a.download = item.attachmentName;
                        a.click();
                    }
                }

                // History
                if (e.target.classList.contains("crf-link")) {
                    e.preventDefault();
                    showHistoryModal(item.History, item.crfId, selectedReleaseType);
                }
            });
        }

        async function saveItem(item) {
            const token = localStorage.getItem('jwtToken');
            const empName = localStorage.getItem('empName') || "Unknown User";

            const payload = [{
                crfId: item.crfId,
                workingStatus: item.workingStatus,
                remarks: item.remarks?.trim() || "",
                attachmentName: item.attachmentName || null,
                attachmentBase64: item.attachmentBase64 || null,
                attachmentMime: item.attachmentMime || null,
                verifiedBy: empName
            }];

            try {
                const res = await fetch('/api/DailyVerification/Save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Saved successfully!");
                    item.isConfirmed = true;
                    renderTable();
                } else {
                    alert("Save failed: " + await res.text());
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        function showHistoryModal(history, crfId, type) {
            const isDaily = type === "Daily Release Report";
            const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
            const badgeText = isDaily ? "Daily" : "Exp.";

            const rows = history.length === 0
                ? `<p class="text-center text-muted">No history</p>`
                : history.map(h => `
                            <div class="d-flex gap-3 mb-3">
                                <div><div class="bg-${h.Status === 'Working' ? 'success' : h.Status === 'Not Working' ? 'danger' : 'secondary'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width:36px;height:36px;">${h.Status?.[0] || '?'}</div></div>
                                <div>
                                    <div class="fw-bold text-${h.Status === 'Working' ? 'success' : h.Status === 'Not Working' ? 'danger' : 'secondary'}">${h.Status}</div>
                                    <div class="small text-muted">by <strong>${h.Employee}</strong> • ${h.DateTime}</div>
                                    ${h.Remarks && h.Remarks !== '-' ? `<div class="mt-2 p-3 bg-light rounded border-start border-4 border-${h.Status === 'Working' ? 'success' : 'danger'}">${h.Remarks.replace(/\n/g, '<br>')}</div>` : '<em class="text-muted">No remarks</em>'}
                                    ${h.Attachment ? `<div class="mt-2"><i class="fas fa-paperclip text-primary"></i> ${h.Attachment}</div>` : ''}
                                </div>
                            </div>
                        `).join('');

            const modal = `
                        <div class="modal fade" id="histModal" tabindex="-1">
                            <div class="modal-dialog modal-lg"><div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">History: <strong>${crfId}</strong> <span class="ms-2 badge ${badgeCls}">${badgeText}</span></h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${rows}</div>
                                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
                            </div></div>
                        </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
            new bootstrap.Modal(document.getElementById('histModal')).show();
            document.getElementById('histModal').addEventListener('hidden.bs.modal', () => document.getElementById('histModal').remove());
        }
    </script>

    <style>
        .is-invalid {
            border-color: #dc3545 !important;
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .crf-link:hover {
            text-decoration: underline;
        }

        .badge {
            font-size: 0.85rem;
        }

        .table th {
            font-weight: 600;
        }
    </style>
}