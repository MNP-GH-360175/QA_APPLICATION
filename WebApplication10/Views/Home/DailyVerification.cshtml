@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}
<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">
            Daily Release Verification
        </h3>
        <span class="text-muted small">Verify released CRFs daily</span>
    </div>
    <!-- Filters Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0">Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional & Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Please select release type</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-6 d-none">
                        <label class="form-label fw-semibold">Tester TL</label>
                        <select class="form-select form-select-lg" id="testerTL">
                            <option value="">All TLs</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-6 d-none">
                        <label class="form-label fw-semibold">Tester Name</label>
                        <select class="form-select form-select-lg" id="testerName">
                            <option value="">All Testers</option>
                        </select>
                    </div>
                    <div class="col-lg-1 col-md-12 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg h-100">
                            Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Results Table Card -->
    <div class="card shadow border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h5 class="mb-0">Verification List</h5>
            <div class="d-flex flex-column flex-md-row gap-3 align-items-md-center">
                <small class="text-light opacity-90">
                    Select Status + Add Remarks → Click <strong>Confirm</strong>
                </small>
                <div class="text-light">
                    <strong>Total Records: <span id="totalRecords">0</span></strong>
                </div>
                <button type="button" class="btn btn-light btn-sm" id="exportExcelBtn">
                    Export to Excel
                </button>
            </div>
        </div>
        <!-- Table Search & Pagination Controls -->
        <div class="card-header border-bottom bg-light px-4 py-3 d-flex flex-column flex-md-row justify-content-between gap-3">
            <div class="col-12 col-md-4">
                <input type="text" class="form-control" id="tableSearch" placeholder="Search by CRF ID or CRF Name..." />
            </div>
            <nav aria-label="Table pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item"><a class="page-link" href="#" id="prevPage">Previous</a></li>
                    <li class="page-item"><a class="page-link" href="#" id="nextPage">Next</a></li>
                </ul>
                <span class="ms-3 text-muted small align-self-center">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </span>
            </nav>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle text-nowrap" id="verificationTable">
                    <thead class="table-primary sticky-top shadow-sm" style="z-index: 10;">
                        <tr>
                            <th class="ps-4">CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th class="text-center" style="min-width:140px;">Status *</th>
                            <th style="min-width:200px;">Remarks *</th>
                            <th style="min-width:140px;">Attachment</th>
                            <th class="text-center" style="min-width:110px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody" class="bg-white"></tbody>
                </table>
            </div>
            <!-- Empty State -->
            <div class="text-center py-5 text-muted" id="emptyState" style="display:none;">
                No records found
                <h5>No records found</h5>
                <p>Try adjusting your filters</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const STATUS_OPTIONS = ["Working", "Not Working", "In Progress", "Data need to capture", "User feedback pending"];
        const STATUS_MAP = { 1: "Working", 2: "Not Working", 3: "In Progress", 4: "Data need to capture", 5: "User feedback pending" };
        let verificationData = [];
        let filteredData = [];
        const pageSize = 10;
        let currentPage = 1;

        const normalizeKeys = obj => new Proxy(obj, {
            get(target, prop) {
                if (prop in target) return target[prop];
                const upper = prop.toUpperCase();
                const found = Object.keys(target).find(k => k.toUpperCase() === upper);
                return found ? target[found] : undefined;
            }
        });

        async function loadFilterDropdowns() {
            try {
                const token = localStorage.getItem('jwtToken');
                if (!token) return;

                // Get current logged-in user name from JWT
                let currentUserName = "Unknown";
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    currentUserName = payload.given_name || payload.name || payload.unique_name || "Unknown";
                } catch (e) {
                    console.error("Failed to parse JWT", e);
                }

                const res = await fetch('/api/DailyVerification/filters', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error("Failed to load filters");
                const data = await res.json();

                const tlSelect = document.getElementById("testerTL");
                const testerSelect = document.getElementById("testerName");

                // Clear and add "All TLs" (optional - you can remove if not needed)
                tlSelect.innerHTML = '<option value="">My TL</option>';
                testerSelect.innerHTML = '<option value="">My Name</option>';

                let userFound = false;

                // Find user's TL and name
                for (const tl of data.testerTLs || []) {
                    const testersRes = await fetch(`/api/DailyVerification/testers/${encodeURIComponent(tl.value)}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (testersRes.ok) {
                        const testers = await testersRes.json();
                        if (testers.some(t => t.value.toUpperCase() === currentUserName.toUpperCase())) {
                            // Found user's TL!
                            tlSelect.innerHTML = `<option value="${tl.value}">${tl.text}</option>`;
                            tlSelect.disabled = true; // Optional: lock it

                            // Populate only this TL's testers
                            testerSelect.innerHTML = '';
                            testers.forEach(t => {
                                const opt = new Option(t.text, t.value);
                                if (t.value.toUpperCase() === currentUserName.toUpperCase()) {
                                    opt.selected = true;
                                    userFound = true;
                                }
                                testerSelect.add(opt);
                            });
                            testerSelect.disabled = true; // Optional: lock name too
                            break;
                        }
                    }
                }

                // Fallback if not found in team structure
                if (!userFound) {
                    // Show all TLs and try to select user
                    tlSelect.innerHTML = '<option value="">All TLs</option>';
                    data.testerTLs?.forEach(x => tlSelect.add(new Option(x.text, x.value)));
                    testerSelect.innerHTML = '<option value="">All Testers</option>';
                    data.testerNames?.forEach(x => {
                        const opt = new Option(x.text, x.value);
                        if (x.value.toUpperCase() === currentUserName.toUpperCase()) opt.selected = true;
                        testerSelect.add(opt);
                    });
                }

            } catch (err) {
                console.error("Error loading filters:", err);
                showToast("Failed to load your team info", "danger");
            }
        }

        function formatDateForOracle(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        document.getElementById("filterForm").addEventListener("submit", async e => {
            e.preventDefault();
            let valid = true;
            document.querySelectorAll("#filterForm [required]").forEach(el => {
                if (!el.value.trim()) {
                    el.classList.add("is-invalid");
                    valid = false;
                } else {
                    el.classList.remove("is-invalid");
                }
            });
            if (!valid) return;
            let currentUserName = "Unknown";
            try {
                const token = localStorage.getItem('jwtToken');
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserName = payload.given_name || payload.name || payload.unique_name || "Unknown";
            } catch { }

            const payload = {
                fromDate: formatDateForOracle(document.getElementById("fromDate").value),
                toDate: formatDateForOracle(document.getElementById("toDate").value),
                releaseType: document.getElementById("releaseType").value || null,
                testerTL:  null,
                testerName: currentUserName
            };

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const rawData = await res.json();
                verificationData = rawData.map(item => normalizeKeys(item));
                verificationData.forEach(item => {
                    item.crfId = item.CRF_ID || "N/A";
                    item.requestId = item.REQUEST_ID || "";
                    item.subject = item.CRF_NAME || "Unknown CRF";
                    item.releaseDate = item.RELEASE_DATE || "";
                    item.techlead = item.TECHLEAD_NAME || "Not Assigned";
                    item.developer = item.DEVELOPER_NAME || "Not Assigned";
                    item.tester = item.TESTER_NAME ? item.TESTER_NAME.replace(/,/g, ', ') : "Not Assigned";
                    item.releaseTypeText = item.RELEASE_TYPE || "";
                    const statusCode = item.WORKING_STATUS ? Number(item.WORKING_STATUS) : null;
                    const verifiedToday = item.VERIFIED_ON && new Date().toDateString() === new Date(item.VERIFIED_ON).toDateString();
                    if (verifiedToday && statusCode) {
                        item.workingStatus = STATUS_MAP[statusCode] || "";
                        item.remarks = item.REMARKS || "";
                        item.attachmentName = item.ATTACHMENT_NAME || "";
                        item.isConfirmed = true;
                    } else {
                        item.workingStatus = "";
                        item.remarks = "";
                        item.attachmentName = "";
                        item.isConfirmed = false;
                    }
                    try {
                        item.History = JSON.parse(item.HISTORY_JSON || "[]");
                    } catch {
                        item.History = [];
                    }
                });
                filteredData = [...verificationData];
                currentPage = 1;
                updateTableAndPagination();
                document.getElementById("resultCard").style.display = verificationData.length > 0 ? "block" : "none";
            } catch (err) {
                alert("Error: " + err.message);
            }
        });

        function updateTableAndPagination() {
            document.getElementById("totalRecords").textContent = filteredData.length;
            const totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
            document.getElementById("totalPages").textContent = totalPages;
            document.getElementById("currentPage").textContent = currentPage;
            document.getElementById("prevPage").parentElement.classList.toggle("disabled", currentPage === 1);
            document.getElementById("nextPage").parentElement.classList.toggle("disabled", currentPage === totalPages);
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById("verificationBody");
            tbody.innerHTML = "";
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);
            if (filteredData.length === 0) {
                document.getElementById("emptyState").style.display = "block";
                return;
            }
            document.getElementById("emptyState").style.display = "none";
            pageData.forEach((item, idx) => {
                const globalIdx = filteredData.indexOf(item);
                const isDaily = item.releaseTypeText.includes("Daily");
                const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
                const badgeText = isDaily ? "Daily" : "Exp.";
                const canConfirm = item.workingStatus && (item.remarks || "").trim().length > 0;
                const row = document.createElement("tr");
                row.innerHTML = `
                                <td class="ps-4"><a href="#" class="text-decoration-none fw-bold text-primary crf-link" data-idx="${globalIdx}">${item.crfId}</a></td>
                                <td><span class="badge bg-secondary fs-7">${item.requestId || 'N/A'}</span></td>
                                <td><span class="badge ${badgeCls} fs-7">${badgeText}</span></td>
                                <td class="text-wrap" title="${item.subject}">${item.subject.length > 50 ? item.subject.substring(0, 47) + '...' : item.subject}</td>
                                <td>${item.releaseDate}</td>
                                <td><strong>${item.techlead}</strong></td>
                                <td>${item.developer}</td>
                                <td><strong>${item.tester}</strong></td>
                                <td class="text-center align-middle">
                                    ${item.isConfirmed
                        ? `<span class="badge bg-success px-3 py-2 fs-7">${item.workingStatus}</span>
                                           <button class="btn btn-sm btn-outline-warning ms-2 edit-btn" data-idx="${globalIdx}">Edit</button>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${globalIdx}">
                                              <option value="">-- Select --</option>
                                              ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${item.workingStatus === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                           </select>`
                    }
                                </td>
                                <td class="align-middle">
                                    <textarea class="form-control form-control-sm remarks-text w-100" rows="2" data-idx="${globalIdx}" ${item.isConfirmed ? 'readonly' : ''}>${item.remarks || ''}</textarea>
                                    <small class="text-muted word-count">${(item.remarks || '').trim().split(/\s+/).filter(Boolean).length} words</small>
                                </td>
                                <td class="align-middle">
                                    ${!item.isConfirmed
                        ? `<input type="file" class="form-control form-control-sm file-input" data-idx="${globalIdx}" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">`
                        : (item.attachmentName ? `<a href="#" class="text-primary download-link" data-idx="${globalIdx}"> ${item.attachmentName}</a>` : '-')
                    }
                                </td>
                                <td class="text-center align-middle">
                                    <button class="btn ${item.isConfirmed ? 'btn-success' : (canConfirm ? 'btn-primary' : 'btn-secondary')} btn-sm px-4 confirm-btn"
                                            data-idx="${globalIdx}" ${item.isConfirmed || !canConfirm ? 'disabled' : ''}>
                                        ${item.isConfirmed ? 'Confirmed' : 'Confirm'}
                                    </button>
                                </td>
                            `;
                tbody.appendChild(row);
            });
            attachEvents();
        }

        function attachEvents() {
            document.querySelectorAll(".status-select").forEach(sel => {
                sel.addEventListener("change", e => {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].workingStatus = e.target.value;
                    filteredData = [...verificationData];
                    updateConfirmButton(idx);
                });
            });
            document.querySelectorAll(".remarks-text").forEach(ta => {
                ta.addEventListener("input", e => {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].remarks = e.target.value;
                    filteredData = [...verificationData];
                    const words = e.target.value.trim().split(/\s+/).filter(w => w).length;
                    e.target.nextElementSibling.textContent = words + " words";
                    updateConfirmButton(idx);
                });
            });
            document.querySelectorAll(".confirm-btn").forEach(btn => {
                btn.addEventListener("click", e => {
                    const idx = e.target.closest("button").dataset.idx;
                    saveItem(verificationData[idx]);
                });
            });
            document.querySelectorAll(".edit-btn").forEach(btn => {
                btn.addEventListener("click", e => {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].isConfirmed = false;
                    filteredData = [...verificationData];
                    renderTable();
                });
            });
            document.querySelectorAll(".crf-link").forEach(link => {
                link.addEventListener("click", e => {
                    e.preventDefault();
                    const idx = e.target.dataset.idx;
                    showHistoryModal(verificationData[idx].History, verificationData[idx].crfId, verificationData[idx].releaseTypeText);
                });
            });
        }

        function updateConfirmButton(idx) {
            const item = verificationData[idx];
            const can = item.workingStatus && (item.remarks || "").trim();
            const btn = document.querySelector(`.confirm-btn[data-idx="${idx}"]`);
            if (btn) {
                btn.disabled = item.isConfirmed || !can;
                btn.className = `btn btn-sm px-4 ${item.isConfirmed ? 'btn-success' : (can ? 'btn-primary' : 'btn-secondary')} confirm-btn`;
                btn.innerHTML = item.isConfirmed ? 'Confirmed' : 'Confirm';
            }
        }

        // Pagination, Search, Export (unchanged)
        document.getElementById("prevPage").addEventListener("click", e => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                updateTableAndPagination();
            }
        });
        document.getElementById("nextPage").addEventListener("click", e => {
            e.preventDefault();
            if (currentPage < Math.ceil(filteredData.length / pageSize)) {
                currentPage++;
                renderTable();
                updateTableAndPagination();
            }
        });
        document.getElementById("tableSearch").addEventListener("input", e => {
            const query = e.target.value.toLowerCase();
            filteredData = verificationData.filter(item =>
                item.crfId.toLowerCase().includes(query) ||
                item.subject.toLowerCase().includes(query)
            );
            currentPage = 1;
            updateTableAndPagination();
        });
        document.getElementById("exportExcelBtn").addEventListener("click", () => {
            if (filteredData.length === 0) {
                alert("No data to export!");
                return;
            }
            const dataToExport = filteredData.map(item => ({
                "CRF ID": item.crfId,
                "Request ID": item.requestId || "N/A",
                "Type": item.releaseTypeText.includes("Daily") ? "Daily" : "Exp.",
                "CRF Name": item.subject,
                "Release Date": item.releaseDate,
                "Tech Lead": item.techlead,
                "Developer": item.developer,
                "Tester": item.tester,
                "Status": item.workingStatus || (item.isConfirmed ? "Confirmed" : "Pending"),
                "Remarks": (item.remarks || "").replace(/\n/g, " "),
                "Attachment": item.attachmentName || "None"
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Verification Data");
            const colWidths = [
                { wch: 12 }, { wch: 15 }, { wch: 8 }, { wch: 50 },
                { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 },
                { wch: 20 }, { wch: 40 }, { wch: 25 }
            ];
            ws['!cols'] = colWidths;
            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `Daily_Release_Verification_${today}.xlsx`);
        });

        // === FIXED saveItem FUNCTION ===
        async function saveItem(item) {
            // Client-side validation
            if (!item.workingStatus) {
                showToast("Please select a Status", "danger");
                return;
            }
            if (!item.remarks || item.remarks.trim().length === 0) {
                showToast("Remarks are mandatory", "danger");
                return;
            }

            const fileInput = document.querySelector(`.file-input[data-idx="${verificationData.indexOf(item)}"]`);
            const file = fileInput?.files[0];
            let attachmentBase64 = null, attachmentName = null, attachmentMime = null;
            if (file) {
                attachmentBase64 = await fileToBase64(file);
                attachmentName = file.name;
                attachmentMime = file.type;
            }

            const payload = [{
                crfId: item.crfId,
                requestId: item.requestId || null,
                releaseDate: item.releaseDate,                    // ← Critical: Now sent!
                workingStatus: item.workingStatus,
                remarks: item.remarks?.trim() || null,
                attachmentName: attachmentName || item.attachmentName || null,
                attachmentBase64: attachmentBase64,
                attachmentMime: attachmentMime
            }];

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification/Save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    showToast("Saved successfully!", "success");
                    // Refresh data with current filters
                    const currentFilters = {
                        fromDate: document.getElementById("fromDate").value,
                        toDate: document.getElementById("toDate").value,
                        releaseType: document.getElementById("releaseType").value || null,
                        testerTL: document.getElementById("testerTL").value || null,
                        testerName: document.getElementById("testerName").value || null
                    };
                    const formattedPayload = {
                        fromDate: formatDateForOracle(currentFilters.fromDate),
                        toDate: formatDateForOracle(currentFilters.toDate),
                        releaseType: currentFilters.releaseType,
                        testerTL: currentFilters.testerTL,
                        testerName: currentFilters.testerName
                    };
                    const refreshRes = await fetch('/api/DailyVerification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(formattedPayload)
                    });
                    if (refreshRes.ok) {
                        const rawData = await refreshRes.json();
                        verificationData = rawData.map(item => normalizeKeys(item));
                        verificationData.forEach(item => {
                            item.crfId = item.CRF_ID || "N/A";
                            item.requestId = item.REQUEST_ID || "";
                            item.subject = item.CRF_NAME || "Unknown CRF";
                            item.releaseDate = item.RELEASE_DATE || "";
                            item.techlead = item.TECHLEAD_NAME || "";
                            item.developer = item.DEVELOPER_NAME || "";
                            item.tester = item.TESTER_NAME || "";
                            item.releaseTypeText = item.RELEASE_TYPE || "";
                            const statusCode = item.WORKING_STATUS ? Number(item.WORKING_STATUS) : null;
                            const verifiedToday = item.VERIFIED_ON && new Date().toDateString() === new Date(item.VERIFIED_ON).toDateString();
                            if (verifiedToday && statusCode) {
                                item.workingStatus = STATUS_MAP[statusCode] || "";
                                item.remarks = item.REMARKS || "";
                                item.attachmentName = item.ATTACHMENT_NAME || "";
                                item.isConfirmed = true;
                            } else {
                                item.workingStatus = "";
                                item.remarks = "";
                                item.attachmentName = "";
                                item.isConfirmed = false;
                            }
                            try {
                                item.History = JSON.parse(item.HISTORY_JSON || "[]");
                            } catch {
                                item.History = [];
                            }
                        });
                        filteredData = [...verificationData];
                        currentPage = 1;
                        updateTableAndPagination();
                    }
                } else {
                    const errorText = await res.text();
                    showToast("Save failed! " + errorText, "danger");
                }
            } catch (err) {
                showToast("Error: " + err.message, "danger");
            }
        }

        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
            toast.style.zIndex = 9999;
            toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>`;
            document.body.appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 3000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showHistoryModal(history, crfId, type) {
            const isDaily = type?.includes("Daily");
            const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
            const badgeText = isDaily ? "Daily" : "Exp.";

            let timelineHtml = "";
            if (history.length === 0) {
                timelineHtml = `<p class='text-center text-muted py-5'>No verification history available</p>`;
            } else {
                // Sort by date descending (latest first)
                history.sort((a, b) => new Date(b.verified_on) - new Date(a.verified_on));

                timelineHtml = history.map((h, index) => {
                    const initials = h.verified_by ? h.verified_by.trim().split(' ').map(n => n[0]).join('').toUpperCase() : '??';
                    const statusColor =
                        h.status_text === 'Working' ? 'bg-success' :
                            h.status_text === 'Not Working' ? 'bg-danger' :
                                h.status_text === 'In Progress' ? 'bg-warning' :
                                    h.status_text === 'Data need to capture' ? 'bg-info' :
                                        h.status_text === 'User feedback pending' ? 'bg-secondary' : 'bg-primary';

                    return `
                                <div class="d-flex gap-4 py-4 ${index < history.length - 1 ? 'border-bottom' : ''}">
                                    <!-- Timeline dot + line -->
                                    <div class="flex-shrink-0 position-relative">
                                        <div class="bg-white rounded-circle border border-3 border-white shadow-sm d-flex align-items-center justify-content-center text-white fw-bold ${statusColor}" style="width:50px;height:50px;">
                                            ${initials}
                                        </div>
                                        ${index < history.length - 1 ? '<div class="position-absolute top-50 start-50 translate-middle-x bg-light" style="width:2px; height:70px; margin-top:30px;"></div>' : ''}
                                    </div>
                                    <!-- Content -->
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1 fw-bold">${h.verified_by || 'Unknown User'}</h6>
                                                <small class="text-muted">${h.verified_on || ''}</small>
                                            </div>
                                            <span class="badge ${statusColor} px-3 py-2">${h.status_text || 'Unknown'}</span>
                                        </div>
                                        ${h.remarks ? `
                                        <div class="mt-3 p-3 bg-light rounded small border">
                                            ${h.remarks.replace(/\n/g, '<br>')}
                                        </div>` : '<em class="text-muted small mt-2 d-block">No remarks provided</em>'}
                                                ${h.attachment_name ? `
        <div class="mt-2">
            <a href="/api/DailyVerification/Attachment/${encodeURIComponent(crfId)}/${encodeURIComponent(type.includes('Daily') ? '16-DEC-2025' : 'EXP-DATE')}"
               target="_blank"
               class="badge bg-info text-dark text-decoration-none">
                <i class="fas fa-download me-1"></i>${h.attachment_name}
            </a>
        </div>` : ''}
                                    </div>
                                </div>`;
                }).join('');
            }

            const modalHtml = `
                        <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content border-0 shadow-lg">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title" id="historyModalLabel">
                                            Verification History: <strong>${crfId}</strong>
                                            <span class="badge ${badgeCls} ms-2">${badgeText}</span>
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
                                        ${timelineHtml}
                                    </div>
                                    <div class="modal-footer border-0">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

            // Remove any existing modal first
            const existing = document.getElementById('historyModal');
            if (existing) existing.remove();

            // Append and show
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal('#historyModal');
            modal.show();

            // Cleanup on hide
            document.getElementById('historyModal').addEventListener('hidden.bs.modal', () => {
                document.getElementById('historyModal').remove();
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadFilterDropdowns();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
}