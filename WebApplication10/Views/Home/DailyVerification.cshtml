@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4">
    <h3 class="mb-4 text-primary">
        Daily Release Verification
    </h3>

    <!-- Filters -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional and Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester TL</label>
                        <select class="form-select" id="testerTL">
                            <option value="">Loading TLs...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tester Name</label>
                        <select class="form-select" id="testerName">
                            <option value="">Loading Testers...</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">
                            Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card shadow-sm border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Verification List</h5>
            <small class="text-light">Select Status + Add Remarks → Click Confirm</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th width="180">Working Status *</th>
                            <th width="300">Remarks *</th>
                            <th width="180">Attachment</th>
                            <th width="130">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const STATUS_OPTIONS = [
            "Working",
            "Not Working",
            "In Progress",
            "Data need to capture",
            "User feedback pending"
        ];

        let verificationData = [];

        // Load TL & Tester dropdowns from API
        async function loadFilterDropdowns() {
            try {
                const token = localStorage.getItem('jwtToken');
                const res = await fetch('/api/DailyVerification/filters', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) throw new Error("Failed to load filters");

                const data = await res.json();

                // Populate Tester TL
                const tlSelect = document.getElementById("testerTL");
                tlSelect.innerHTML = '<option value="">All TLs</option>';
                data.testerTLs?.forEach(x => {
                    const opt = document.createElement("option");
                    opt.value = x.value;
                    opt.textContent = x.text;
                    tlSelect.appendChild(opt);
                });

                // Populate Tester Name
                const testerSelect = document.getElementById("testerName");
                testerSelect.innerHTML = '<option value="">All Testers</option>';
                data.testerNames?.forEach(x => {
                    const opt = document.createElement("option");
                    opt.value = x.value;
                    opt.textContent = x.text;
                    testerSelect.appendChild(opt);
                });

            } catch (err) {
                console.error("Failed to load dropdowns:", err);
                document.getElementById("testerTL").innerHTML = '<option value="">Error loading TLs</option>';
                document.getElementById("testerName").innerHTML = '<option value="">Error loading Testers</option>';
            }
        }

        function formatDateForOracle(dateStr) {
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        function getStatusBadge(status) {
            const map = {
                "Working": "bg-success text-white",
                "Not Working": "bg-danger text-white",
                "In Progress": "bg-warning text-dark",
                "Data need to capture": "bg-info text-white",
                "User feedback pending": "bg-secondary text-white"
            };
            return map[status] || "bg-secondary text-white";
        }

        // Search
        document.getElementById("filterForm").addEventListener("submit", async e => {
            e.preventDefault();

            let valid = true;
            document.querySelectorAll("#filterForm [required]").forEach(el => {
                if (!el.value.trim()) {
                    el.classList.add("is-invalid");
                    valid = false;
                } else {
                    el.classList.remove("is-invalid");
                }
            });
            if (!valid) return;

            const payload = {
                fromDate: formatDateForOracle(document.getElementById("fromDate").value),
                toDate: formatDateForOracle(document.getElementById("toDate").value),
                releaseType: document.getElementById("releaseType").value || null,
                testerTL: document.getElementById("testerTL").value || null,
                testerName: document.getElementById("testerName").value || null
            };

            const token = localStorage.getItem('jwtToken');

            try {
                const res = await fetch('/api/DailyVerification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                verificationData = await res.json();

                // Map API response to clean properties
                verificationData.forEach(item => {
                    item.crfId = (item.crF_ID || item.CRF_ID || "N/A").toString().trim();
                    item.requestId = (item.requesT_ID || item.REQUEST_ID || "").toString().trim();
                    item.subject = (item.crF_NAME || item.CRF_NAME || "Not Available").trim();
                    item.releaseDate = item.releasE_DATE || item.RELEASE_DATE || "";
                    item.techlead = (item.techleaD_NAME || item.TECHLEAD_NAME || "Not Assigned");
                    item.developer = (item.developeR_NAME || item.DEVELOPER_NAME || "Not Assigned");
                    item.tester = (item.testeR_NAME || item.TESTER_NAME || "Not Assigned");
                    item.testerTL = (item.testeR_TL_NAME || item.TESTER_TL_NAME || "Not Assigned");
                    item.releaseTypeText = (item.releasE_TYPE_TEXT || item.RELEASE_TYPE_TEXT || "");

                    const verifiedToday = item.currenT_VERIFIED_ON &&
                        new Date(item.currenT_VERIFIED_ON).toDateString() === new Date().toDateString();

                    if (verifiedToday && item.currenT_STATUS) {
                        item.workingStatus = item.currenT_STATUS;
                        item.remarks = item.currenT_REMARKS || "";
                        item.attachmentName = item.currenT_ATTACHMENT_NAME || "";
                        item.isConfirmed = true;
                    } else {
                        item.workingStatus = "";
                        item.remarks = "";
                        item.attachmentName = "";
                        item.attachmentBase64 = null;
                        item.isConfirmed = false;
                    }

                    try {
                        item.History = JSON.parse(item.historY_JSON || item.HISTORY_JSON || "[]");
                    } catch { item.History = []; }
                });

                document.getElementById("resultCard").style.display = verificationData.length ? "block" : "none";
                renderTable();

            } catch (err) {
                alert("Error: " + err.message);
                console.error(err);
            }
        });

        function renderTable() {
            const tbody = document.getElementById("verificationBody");
            tbody.innerHTML = "";

            verificationData.forEach((item, idx) => {
                const isDaily = item.releaseTypeText.includes("Daily");
                const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
                const badgeText = isDaily ? "Daily" : "Exp.";
                const canConfirm = item.workingStatus && item.remarks?.trim();

                const tr = document.createElement("tr");
                tr.innerHTML = `
                        <td><a href="#" class="text-primary fw-bold crf-link" data-idx="${idx}">${item.crfId}</a></td>
                        <td><span class="badge bg-secondary">${item.requestId || 'N/A'}</span></td>
                        <td><span class="badge ${badgeCls}">${badgeText}</span></td>
                        <td title="${item.subject}">${item.subject.length > 60 ? item.subject.substring(0, 57) + '...' : item.subject}</td>
                        <td>${item.releaseDate}</td>
                        <td><strong>${item.techlead}</strong></td>
                        <td>${item.developer}</td>
                        <td>${item.tester}</td>
                                <td>
            ${item.isConfirmed
                        ? `<span class="badge ${getStatusBadge(item.workingStatus)} px-3 py-2">${item.workingStatus}</span>
                   <button class="btn btn-sm btn-outline-warning ms-2 edit-btn" data-idx="${idx}">Edit</button>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${idx}">
                    <option value="">-- Select Status --</option>
                    ${STATUS_OPTIONS.map(opt =>
                            `<option value="${opt}" ${item.workingStatus === opt ? 'selected' : ''}>${opt}</option>`
                        ).join('')}
                   </select>`
                    }
        </td>
                        <td>
                            <textarea class="form-control form-control-sm remarks-text" rows="2" data-idx="${idx}" ${item.isConfirmed ? 'readonly' : ''}>${item.remarks || ''}</textarea>
                            <small class="text-muted d-block">${(item.remarks || '').trim().split(/\s+/).filter(w => w).length} words</small>
                        </td>
                        <td>
                            ${!item.isConfirmed
                        ? `<input type="file" class="form-control form-control-sm file-input" data-idx="${idx}" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt">`
                        : ''
                    }
                            ${item.attachmentName
                        ? `<a href="#" class="text-primary download-link" data-idx="${idx}"> ${item.attachmentName}</a>`
                        : ''
                    }
                        </td>
                        <td>
                            <button class="btn btn-sm ${item.isConfirmed ? 'btn-success' : 'btn-primary'} confirm-btn"
                                    data-idx="${idx}" ${item.isConfirmed || !canConfirm ? 'disabled' : ''}>
                                ${item.isConfirmed ? 'Confirmed' : 'Confirm'}
                            </button>
                        </td>
                    `;
                tbody.appendChild(tr);
            });

            attachEvents();
        }

        function attachEvents() {
            document.getElementById("verificationBody").onclick = e => {
                const idx = e.target.dataset.idx;
                if (idx === undefined) return;
                const item = verificationData[idx];
                const row = e.target.closest("tr");

                // Status change — DO NOT re-render whole table!
                if (e.target.classList.contains("status-select")) {
                    item.workingStatus = e.target.value;
                    const remarks = row.querySelector(".remarks-text").value.trim();
                    const confirmBtn = row.querySelector(".confirm-btn");
                    confirmBtn.disabled = !(item.workingStatus && remarks);
                    return;
                }

                // Remarks change
                if (e.target.classList.contains("remarks-text")) {
                    setTimeout(() => {
                        item.remarks = e.target.value;
                        const status = row.querySelector(".status-select")?.value || "";
                        const confirmBtn = row.querySelector(".confirm-btn");
                        confirmBtn.disabled = !(status && item.remarks.trim());
                    }, 100);
                    return;
                }

                // File upload
                if (e.target.classList.contains("file-input") && e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.size > 10 * 1024 * 1024) {
                        alert("Max 10MB allowed");
                        e.target.value = "";
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = () => {
                        item.attachmentBase64 = reader.result;
                        item.attachmentName = file.name;
                        item.attachmentMime = file.type;
                        renderTable(); // Only re-render on file upload
                    };
                    reader.readAsDataURL(file);
                    return;
                }

                // Confirm
                if (e.target.classList.contains("confirm-btn") && !e.target.disabled) {
                    saveItem(item);
                    return;
                }

                // Edit
                if (e.target.classList.contains("edit-btn")) {
                    item.isConfirmed = false;
                    renderTable();
                    return;
                }

                // Download
                if (e.target.classList.contains("download-link")) {
                    e.preventDefault();
                    if (item.attachmentBase64) {
                        const a = document.createElement("a");
                        a.href = item.attachmentBase64;
                        a.download = item.attachmentName;
                        a.click();
                    }
                    return;
                }

                // History
                if (e.target.classList.contains("crf-link")) {
                    e.preventDefault();
                    showHistoryModal(item.History, item.crfId, item.releaseTypeText);
                }
            };
        }

        async function saveItem(item) {
            const payload = [{
                crfId: item.crfId,
                requestId: item.requestId,
                workingStatus: item.workingStatus,
                remarks: item.remarks?.trim() || "",
                attachmentName: item.attachmentName || null,
                attachmentBase64: item.attachmentBase64 || null,
                attachmentMime: item.attachmentMime || null
            }];

            const token = localStorage.getItem('jwtToken');
            try {
                const res = await fetch('/api/DailyVerification/Save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Saved successfully!");
                    item.isConfirmed = true;
                    renderTable();
                } else {
                    alert("Save failed: " + await res.text());
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        function showHistoryModal(history, crfId, type) {
            const isDaily = type?.includes("Daily");
            const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
            const badgeText = isDaily ? "Daily" : "Exp.";

            const rows = history.length === 0
                ? `<p class="text-center text-muted">No history</p>`
                : history.map(h => `
                        <div class="d-flex gap-3 mb-3">
                            <div><div class="bg-${h.Status === 'Working' ? 'success' : 'danger'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width:36px;height:36px;">${h.Status?.[0] || '?'}</div></div>
                            <div>
                                <div class="fw-bold text-${h.Status === 'Working' ? 'success' : 'danger'}">${h.Status}</div>
                                <div class="small text-muted">by <strong>${h.Employee}</strong> • ${h.DateTime}</div>
                                ${h.Remarks ? `<div class="mt-2 p-3 bg-light rounded border-start border-4 border-${h.Status === 'Working' ? 'success' : 'danger'}">${h.Remarks.replace(/\n/g, '<br>')}</div>` : '<em>No remarks</em>'}
                                ${h.Attachment ? `<div class="mt-2"> ${h.Attachment}</div>` : ''}
                            </div>
                        </div>
                    `).join('');

            const modal = `
                    <div class="modal fade" id="histModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">History: <strong>${crfId}</strong> <span class="badge ${badgeCls} ms-2">${badgeText}</span></h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${rows}</div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
            new bootstrap.Modal('#histModal').show();
            document.getElementById('histModal').addEventListener('hidden.bs.modal', () => document.getElementById('histModal').remove());
        }

        // Load dropdowns when page loads
        document.addEventListener("DOMContentLoaded", loadFilterDropdowns);
    </script>

    <style>
        .is-invalid {
            border-color: #dc3545 !important;
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .crf-link:hover {
            text-decoration: underline;
        }

        .table th {
            font-weight: 600;
        }

        textarea[readonly] {
            background-color: #f8f9fa;
        }
    </style>
}