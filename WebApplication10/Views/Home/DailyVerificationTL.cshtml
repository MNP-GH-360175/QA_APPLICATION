@using System.Security.Claims
@{
    ViewData["Title"] = "Daily Verification - Tech Lead";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var currentTLName = User.FindFirst(ClaimTypes.GivenName)?.Value ??
                        User.FindFirst(ClaimTypes.Name)?.Value ??
                        User.FindFirst("unique_name")?.Value ?? "";
}

<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">Daily Verification - Tech Lead</h3>
        <span class="text-muted small">Review tester verifications • Confirm, Return or Close</span>
    </div>

    <!-- Filters -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0">Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="tlFilterForm">
                <div class="row g-3 align-items-end">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="tlFromDate" required />
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="tlToDate" required />
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Tester</label>
                        <select class="form-select" id="tlTesterSelect">
                            <option value="">All Testers in My Team</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results -->
    <div class="card shadow border-0" id="tlResultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Pending for TL Approval</h5>
            <button class="btn btn-light btn-sm" id="tlExportExcel">
                <i class="fas fa-file-excel me-1"></i> Export to Excel
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="tlTable">
                    <thead class="table-primary sticky-top">
                        <tr>
                            <th>CRF ID</th>
                            <th>Request ID</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th>Status</th>
                            <th>Tester Remarks</th>
                            <th>Attachment</th>
                            <th>TL Remarks *</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tlBody"></tbody>
                </table>
            </div>
            <div class="text-center py-5 text-muted" id="tlEmpty" style="display:none;">
                <h5>No pending verifications found</h5>
                <p>Please adjust your filters and try again.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let tlData = [];
        const currentTLName = "@Html.Raw(currentTLName)";

        function getSubTeamId(tlName) {
            const map = {
                "JIJIN E H": 1, "MURUGESAN P": 2, "NIKHIL SEKHAR": 3,
                "SMINA BENNY": 4, "VISAGH S": 5, "JOBY JOSE": 6
            };
            return map[tlName?.trim().toUpperCase()] || null;
        }

        async function loadMyTesters() {
            if (!currentTLName?.trim()) {
                console.warn("No TL name found in user claims");
                return;
            }

            const subTeamId = getSubTeamId(currentTLName);
            if (!subTeamId) {
                document.getElementById('tlTesterSelect').innerHTML = '<option value="">No team assigned</option>';
                return;
            }

            const token = localStorage.getItem('jwtToken');
            const select = document.getElementById('tlTesterSelect');
            select.innerHTML = '<option value="">Loading team...</option>';

            try {
                const res = await fetch(`/api/Verification/team/${subTeamId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (res.ok) {
                    const testers = await res.json();

                    // Clear and add default "All" option
                    select.innerHTML = '<option value="">All Testers in My Team</option>';

                    if (testers.length === 0) {
                        select.innerHTML += '<option value="" disabled>No testers found</option>';
                    } else {
                        // Add each individual tester
                        testers.forEach(t => {
                            if (t.text && t.value) {
                                const option = new Option(t.text, t.value);
                                select.add(option);
                            }
                        });
                    }
                } else {
                    select.innerHTML = '<option value="">Error loading team</option>';
                }
            } catch (err) {
                console.error("Exception loading team:", err);
                select.innerHTML = '<option value="">Failed to load team</option>';
            }
        }

        function formatDateForOracle(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        document.getElementById('tlFilterForm').addEventListener('submit', async e => {
            e.preventDefault();
            const from = document.getElementById('tlFromDate').value;
            const to = document.getElementById('tlToDate').value;
            if (!from || !to) return alert("Select both dates");
            if (new Date(from) > new Date(to)) return alert("From Date > To Date");

            const payload = {
                fromDate: formatDateForOracle(from),
                toDate: formatDateForOracle(to),
                releaseType: null,
                testerName: document.getElementById('tlTesterSelect').value || null
            };

            const token = localStorage.getItem('jwtToken');
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = 'Searching...';

            try {
                const res = await fetch('/api/Verification/tlview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());
                tlData = await res.json();
                renderTLTable();
                document.getElementById('tlResultCard').style.display = 'block';
                document.getElementById('tlEmpty').style.display = tlData.length ? 'none' : 'block';
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search me-2"></i>Search';
            }
        });

        function renderTLTable() {
            const tbody = document.getElementById('tlBody');
            tbody.innerHTML = '';
            if (!tlData.length) return;

            const statusMap = { 1: 'Working', 2: 'Not Working', 3: 'In Progress', 4: 'Data need to capture', 5: 'User feedback pending', 6: 'On Hold' };

            tlData.forEach(item => {
                const status = statusMap[item.WORKING_STATUS] || 'Pending';
                const row = document.createElement('tr');
                row.innerHTML = `
                            <td class="fw-bold">${item.CRF_ID || 'N/A'}</td>
                            <td>${item.REQUEST_ID || 'N/A'}</td>
                            <td class="text-wrap" style="max-width:300px;">${item.CRF_NAME || 'No CRF Name'}</td>
                            <td>${item.RELEASE_DATE || 'N/A'}</td>
                            <td>${item.TECHLEAD || 'N/A'}</td>
                            <td>${item.DEVELOPER || 'N/A'}</td>
                            <td><strong>${item.TESTER || 'N/A'}</strong></td>
                            <td><span class="badge ${item.WORKING_STATUS == 1 ? 'bg-success' : 'bg-warning'}">${status}</span></td>
                            <td class="text-wrap small">${item.REMARKS || '-'}</td>
                            <td>${item.ATTACHMENT_NAME ? `<a href="/api/Verification/Attachment/${encodeURIComponent(item.CRF_ID || '')}/${encodeURIComponent(item.RELEASE_DATE || '')}" target="_blank">
                                <i class="fas fa-paperclip"></i> ${item.ATTACHMENT_NAME}</a>` : '-'}</td>
                            <td><textarea class="form-control form-control-sm" rows="3" placeholder="Enter TL remarks (required for Confirm)...">${item.TL_REMARKS || ''}</textarea></td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm confirm-tl me-1" data-crf="${item.CRF_ID || ''}" data-date="${item.RELEASE_DATE || ''}">Confirm</button>
                                <button class="btn btn-warning btn-sm return-tl" data-crf="${item.CRF_ID || ''}" data-date="${item.RELEASE_DATE || ''}">Return</button>
                                ${[2, 5].includes(item.VERIFY_STATUS) ? '' : `<button class="btn btn-danger btn-sm close-tl ms-1" data-crf="${item.CRF_ID || ''}" data-date="${item.RELEASE_DATE || ''}">Close</button>`}
                            </td>
                        `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.confirm-tl').forEach(b => b.onclick = () => tlAction(b.dataset.crf, b.dataset.date, 'CONFIRM'));
            document.querySelectorAll('.return-tl').forEach(b => b.onclick = () => tlAction(b.dataset.crf, b.dataset.date, 'RETURN'));
            document.querySelectorAll('.close-tl').forEach(b => b.onclick = () => tlAction(b.dataset.crf, b.dataset.date, 'CLOSE'));
        }

        async function tlAction(crfId, releaseDate, action) {
            const row = event.target.closest('tr');
            const remarks = row.querySelector('textarea').value.trim();

            if (action === 'CONFIRM' && !remarks) return alert("TL Remarks required for Confirm");
            if (action === 'CLOSE' && !confirm("Mark as Live and Closed? This is final.")) return;

            const payload = [{ crfId, releaseDate, tlRemarks: remarks, action }];
            const token = localStorage.getItem('jwtToken');

            try {
                const res = await fetch('/api/Verification/tlsave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert(action === 'CONFIRM' ? "Confirmed!" : action === 'RETURN' ? "Returned" : "Closed");
                    document.getElementById('tlFilterForm').dispatchEvent(new Event('submit'));
                } else {
                    alert("Failed: " + await res.text());
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        document.addEventListener("DOMContentLoaded", loadMyTesters);
    </script>
}