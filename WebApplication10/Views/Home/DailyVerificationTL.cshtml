@using System.Security.Claims

@{
    ViewData["Title"] = "Daily Verification - Tech Lead";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    var currentTLName = User.FindFirst(ClaimTypes.GivenName)?.Value ??
                        User.FindFirst(ClaimTypes.Name)?.Value ??
                        User.FindFirst("unique_name")?.Value ?? "";
}

<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">Daily Verification - Tech Lead</h3>
        <span class="text-muted small">Review tester verifications • Confirm or Return</span>
    </div>

    <!-- Filters -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0">Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="tlFilterForm">
                <div class="row g-3 align-items-end">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="tlFromDate" required />
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="tlToDate" required />
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Tester</label>
                        <select class="form-select" id="tlTesterSelect">
                            <option value="">All Testers in My Team</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results -->
    <div class="card shadow border-0" id="tlResultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Pending for TL Approval</h5>
            <button class="btn btn-light btn-sm" id="tlExportExcel">
                <i class="fas fa-file-excel me-1"></i> Export to Excel
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="tlTable">
                    <thead class="table-primary sticky-top">
                        <tr>
                            <th>CRF ID</th>
                            <th>Request ID</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester</th>
                            <th>Status</th>
                            <th>Tester Remarks</th>
                            <th>Attachment</th>
                            <th>TL Remarks *</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tlBody"></tbody>
                </table>
            </div>
            <div class="text-center py-5 text-muted" id="tlEmpty" style="display:none;">
                <h5>No pending verifications</h5>
                <p>All tester verifications are up to date or returned.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let tlData = [];

        const currentTLName = "@Html.Raw(currentTLName)";

        async function loadMyTesters() {
            if (!currentTLName || currentTLName.trim() === "") return;

            const token = localStorage.getItem('jwtToken');
            if (!token) return;

            try {
                const res = await fetch(`/api/Verification/testers/${encodeURIComponent(currentTLName)}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (res.ok) {
                    const testers = await res.json();
                    const select = document.getElementById('tlTesterSelect');
                    select.innerHTML = '<option value="">All Testers in My Team</option>';
                    testers.forEach(t => select.add(new Option(t.text, t.value)));
                }
            } catch (err) {
                console.error("Error loading testers:", err);
            }
        }

        function formatDateForOracle(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        document.getElementById('tlFilterForm').addEventListener('submit', async e => {
            e.preventDefault();

            const from = document.getElementById('tlFromDate').value;
            const to = document.getElementById('tlToDate').value;

            if (!from || !to) {
                alert("Please select both dates");
                return;
            }

            const payload = {
                fromDate: formatDateForOracle(from),
                toDate: formatDateForOracle(to),
                releaseType: null,
                testerName: document.getElementById('tlTesterSelect').value || null
            };

            const token = localStorage.getItem('jwtToken');

            try {
                const res = await fetch('/api/Verification/TLView', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text() || "Failed to load data");

                tlData = await res.json();
                renderTLTable();

                document.getElementById('tlResultCard').style.display = tlData.length > 0 ? 'block' : 'none';
                document.getElementById('tlEmpty').style.display = tlData.length === 0 ? 'block' : 'none';
            } catch (err) {
                alert("Error: " + err.message);
            }
        });

        function renderTLTable() {
            const tbody = document.getElementById('tlBody');
            tbody.innerHTML = '';

            if (tlData.length === 0) return;

            const statusMap = { 1: 'Working', 2: 'Not Working', 3: 'In Progress', 4: 'Data need to capture', 5: 'User feedback pending' };

            tlData.forEach(item => {
                const row = document.createElement('tr');
                const testerStatus = statusMap[item.WORKING_STATUS] || 'Pending';

                row.innerHTML = `
                            <td class="fw-bold"><a href="#" class="text-primary crf-link" data-crf="${item.CRF_ID}">${item.CRF_ID}</a></td>
                            <td>${item.REQUEST_ID || 'N/A'}</td>
                            <td class="text-wrap" style="max-width:300px;">${item.CRF_NAME}</td>
                            <td>${item.RELEASE_DATE}</td>
                            <td>${item.TECHLEAD_NAME}</td>
                            <td>${item.DEVELOPER_NAME}</td>
                            <td><strong>${item.TESTER_NAME}</strong></td>
                            <td><span class="badge bg-info">${testerStatus}</span></td>
                            <td class="text-wrap small">${item.REMARKS || '-'}</td>
                            <td>
                                ${item.ATTACHMENT_NAME
                        ? `<a href="/api/Verification/Attachment/${encodeURIComponent(item.CRF_ID)}/${encodeURIComponent(item.RELEASE_DATE)}" target="_blank">
                                         <i class="fas fa-paperclip"></i> ${item.ATTACHMENT_NAME}
                                       </a>`
                        : '-'}
                            </td>
                            <td>
                                <textarea class="form-control form-control-sm" rows="3" placeholder="Enter TL remarks...">${item.TL_REMARKS || ''}</textarea>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm confirm-tl me-1" data-crf="${item.CRF_ID}" data-date="${item.RELEASE_DATE}">
                                    <i class="fas fa-check"></i> Confirm
                                </button>
                                <button class="btn btn-warning btn-sm return-tl" data-crf="${item.CRF_ID}" data-date="${item.RELEASE_DATE}">
                                    <i class="fas fa-undo"></i> Return
                                </button>
                            </td>
                        `;
                tbody.appendChild(row);
            });

            // Attach events
            document.querySelectorAll('.confirm-tl').forEach(btn => btn.addEventListener('click', () => tlAction(btn.dataset.crf, btn.dataset.date, 2)));
            document.querySelectorAll('.return-tl').forEach(btn => btn.addEventListener('click', () => tlAction(btn.dataset.crf, btn.dataset.date, 3)));
            document.querySelectorAll('.crf-link').forEach(link => link.addEventListener('click', e => {
                e.preventDefault();
                const item = tlData.find(x => x.CRF_ID === e.target.dataset.crf);
                if (item?.HISTORY_JSON) showHistoryModal(JSON.parse(item.HISTORY_JSON || "[]"), item.CRF_ID);
            }));
        }

        async function tlAction(crfId, releaseDate, status) {
            const row = event.target.closest('tr');
            const remarks = row.querySelector('textarea').value.trim();

            if (status === 2 && !remarks) {
                alert("TL Remarks are required to Confirm");
                return;
            }

            const payload = [{ crfId, releaseDate, tlRemarks: remarks, tlStatus: status }];
            const token = localStorage.getItem('jwtToken');

            try {
                const res = await fetch('/api/Verification/TLSave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert(status === 2 ? "Confirmed successfully!" : "Returned to tester");
                    document.getElementById('tlFilterForm').dispatchEvent(new Event('submit'));
                } else {
                    alert("Failed: " + await res.text());
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        document.getElementById('tlExportExcel')?.addEventListener('click', () => {
            if (tlData.length === 0) {
                alert("No data to export");
                return;
            }

            const exportData = tlData.map(item => ({
                "CRF ID": item.CRF_ID,
                "Request ID": item.REQUEST_ID || "N/A",
                "CRF Name": item.CRF_NAME,
                "Release Date": item.RELEASE_DATE,
                "Tech Lead": item.TECHLEAD_NAME,
                "Developer": item.DEVELOPER_NAME,
                "Tester": item.TESTER_NAME,
                "Tester Status": item.WORKING_STATUS ? ["", "Working", "Not Working", "In Progress", "Data need to capture", "User feedback pending"][item.WORKING_STATUS] : "",
                "Tester Remarks": item.REMARKS || "",
                "TL Remarks": item.TL_REMARKS || "",
                "Status": item.VERIFY_STATUS === 2 ? "TL Confirmed" : item.VERIFY_STATUS === 3 ? "Returned" : "Pending TL Review"
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "TL Verification");
            ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 50 }, { wch: 15 }, { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 40 }, { wch: 20 }];

            XLSX.writeFile(wb, `TL_Daily_Verification_${new Date().toISOString().slice(0, 10)}.xlsx`);
        });

        function showHistoryModal(history, crfId) {
            alert(`History for CRF ${crfId}:\n${JSON.stringify(history, null, 2)}`);
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadMyTesters();

            const today = new Date();
            const from = new Date(today);
            from.setDate(today.getDate() - 7);

            document.getElementById('tlFromDate').valueAsDate = from;
            document.getElementById('tlToDate').valueAsDate = today;
        });
    </script>
}